version: 2
jobs:
  build:
    machine: true
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: run tests
          # Note that we want to run `docker build` rather than `docker-compose build`
          # here to ensure that layers are cached properly. This works around
          # https://github.com/docker/compose/issues/883.
          command: |
            docker build --target dev -t justfixnyc/nycdb-k8s-loader:dev .
            cp .env.example .env
            docker-compose run app pytest
      - run:
        name: build production container
        command: |
          docker build --target prod -t justfixnyc/nycdb-k8s-loader:latest .
